<!doctype html>
<html lang="tr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Online Sınav</title>
    <style>
        :root { --bg:#0b1020; --card:#121833; --muted:#9aa4c7; --text:#e8ecff; --accent:#5b8cff; --ok:#21c07a; --err:#ff6b6b; }
        * { box-sizing: border-box; }
        body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background: linear-gradient(180deg,#0a0f22, #0b1020); color: var(--text); }
        .wrap { max-width: 820px; margin: 40px auto; padding: 0 16px; }
        .card { background: var(--card); border: 1px solid rgba(255,255,255,.06); border-radius: 16px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,.25);}
        h1 { font-size: 24px; margin: 0 0 12px; letter-spacing:.3px; }
        h2 { font-size: 18px; margin: 20px 0 8px; color: var(--muted); font-weight:600; }
        label { display:block; font-size:14px; color: var(--muted); margin: 8px 0 6px; }
        input[type="text"], input[type="password"], textarea, select {
          width:100%; padding:12px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.08);
          background:#0f1630; color:var(--text); outline:none;
        }
        textarea{ min-height:100px; resize: vertical; }
        .row { display:flex; gap:12px; }
        .row > * { flex:1; }
        .btn {
          background: var(--accent); color:white; padding: 10px 16px; border-radius: 12px; border: none; cursor: pointer; font-weight:600;
          transition: transform .05s ease, filter .2s ease;
        }
        .btn:active { transform: scale(.98); }
        .btn.secondary { background: #2a335b; }
        .btn.ok { background: var(--ok); }
        .btn.err { background: var(--err); }
        .muted { color: var(--muted); font-size: 13px; }
        .spacer { height: 16px; }
        .hidden { display:none !important; }
        .q { padding:14px; border:1px solid rgba(255,255,255,.06); border-radius:12px; margin:10px 0; background:#0f1630; }
        .q-title { font-weight:600; margin-bottom:8px; }
        .radio { display:flex; gap:10px; align-items:center; margin:6px 0; }
        .tag { display:inline-block; font-size:11px; padding:2px 8px; background:#19214a; color:#a8b3da; border-radius:999px; margin-left:8px; }
        .alert { margin-top:10px; padding:10px 12px; border-radius:10px; }
        .alert.ok { background: rgba(33,192,122,.12); border:1px solid rgba(33,192,122,.35); }
        .alert.err { background: rgba(255,107,107,.12); border:1px solid rgba(255,107,107,.35); }
    </style>
</head>
<body>
<div class="wrap">
    <div class="card">
        <h1>Online Sınav</h1>
        <div id="loginView">
            <h2>Giriş</h2>
            <div class="row">
                <div>
                    <label>Kullanıcı Adı</label>
                    <input id="username" type="text" autocomplete="username" />
                </div>
                <div>
                    <label>Şifre</label>
                    <input id="password" type="password" autocomplete="current-password" />
                </div>
            </div>
            <div class="spacer"></div>
            <div class="row">
                <button id="btnLogin" class="btn">Giriş Yap</button>
                <button id="btnLogout" class="btn secondary hidden">Çıkış</button>
            </div>
            <div id="loginMsg" class="muted"></div>
        </div>

        <div id="examView" class="hidden">
            <h2>Sınav</h2>
            <div class="row">
                <div>
                    <label>Sınav ID</label>
                    <input id="examId" type="text" placeholder="örn. 5" />
                </div>
                <div style="align-self:end;">
                    <button id="btnLoadExam" class="btn">Soruları Getir</button>
                </div>
            </div>
            <div id="examMeta" class="spacer muted"></div>
            <div id="questions"></div>
            <div class="spacer"></div>
            <button id="btnSubmit" class="btn ok hidden">Cevapları Gönder</button>
            <div id="submitMsg"></div>
        </div>
    </div>
</div>

<script>

    const BASE_URL = "";

    const $ = sel => document.querySelector(sel);
    const loginView = $("#loginView");
    const examView  = $("#examView");
    const loginMsg  = $("#loginMsg");
    const submitMsg = $("#submitMsg");
    const questionsEl = $("#questions");
    const btnLogin = $("#btnLogin");
    const btnLogout = $("#btnLogout");
    const btnLoadExam = $("#btnLoadExam");
    const btnSubmit = $("#btnSubmit");
    const examMeta = $("#examMeta");

    let currentExam = null;

    function token() { return localStorage.getItem("token"); }
    function setToken(t) {
      if (t) localStorage.setItem("token", t);
      else localStorage.removeItem("token");
      updateAuthUI();
    }
    function authHeaders() {
      const t = token();
      return t ? { "Authorization": "Bearer " + t } : {};
    }
    function updateAuthUI() {
      const isAuthed = !!token();
      loginView.querySelector("#username").disabled = isAuthed;
      loginView.querySelector("#password").disabled = isAuthed;
      btnLogin.classList.toggle("hidden", isAuthed);
      btnLogout.classList.toggle("hidden", !isAuthed);
      examView.classList.toggle("hidden", !isAuthed);
      loginMsg.textContent = isAuthed ? "Giriş başarılı." : "";
    }

    async function api(path, opts = {}) {
      const headers = Object.assign({ "Content-Type": "application/json" }, authHeaders(), opts.headers||{});
      const res = await fetch(BASE_URL + path, { ...opts, headers });
      let body = null;
      const ct = res.headers.get("Content-Type") || "";
      if (ct.includes("application/json")) {
        body = await res.json().catch(()=>null);
      } else {
        body = await res.text().catch(()=>null);
      }
      if (!res.ok) {
        const msg = body && body.message ? body.message : ("HTTP " + res.status);
        throw new Error(msg);
      }
      return body;
    }

    btnLogin.addEventListener("click", async () => {
      const username = $("#username").value.trim();
      const password = $("#password").value;
      loginMsg.textContent = "";
      try {
        if (!username || !password) throw new Error("Kullanıcı adı/şifre gerekli.");
        const data = await api("/login", {
          method: "POST",
          body: JSON.stringify({ username, password })
        });
        setToken(data.token);
      } catch (e) {
        setToken(null);
        loginMsg.textContent = "Giriş başarısız: " + e.message;
      }
    });

    btnLogout.addEventListener("click", () => {
      setToken(null);
      currentExam = null;
      questionsEl.innerHTML = "";
      examMeta.textContent = "";
      $("#examId").value = "";
      submitMsg.innerHTML = "";
    });

    btnLoadExam.addEventListener("click", async () => {
      submitMsg.innerHTML = "";
      const idStr = $("#examId").value.trim();
      if (!idStr) { alert("Sınav ID girin."); return; }
      try {
        const data = await api(`/exams/${encodeURIComponent(idStr)}`);
        currentExam = data;
        renderExam(data);
        btnSubmit.classList.remove("hidden");
      } catch (e) {
        currentExam = null;
        questionsEl.innerHTML = "";
        btnSubmit.classList.add("hidden");
        examMeta.textContent = "";
        submitMsg.innerHTML = `<div class="alert err">Sınav yüklenemedi: ${e.message}</div>`;
      }
    });

    btnSubmit.addEventListener("click", async () => {
      if (!currentExam) return;
      try {
        const answers = collectAnswers();
        if (answers.length === 0) { alert("En az bir cevap girin."); return; }
        const body = { examId: currentExam.examId, answers };
        const result = await api("/submit", { method:"POST", body: JSON.stringify(body) });
        submitMsg.innerHTML = `
          <div class="alert ok">
            <strong>Skor:</strong> ${result.score}/${result.totalQuestions}
            &nbsp;&nbsp;|&nbsp;&nbsp;<strong>Doğru:</strong> ${result.correctCount}
          </div>`;
      } catch (e) {
        submitMsg.innerHTML = `<div class="alert err">Gönderim hatası: ${e.message}</div>`;
      }
    });

    function renderExam(exam) {
      examMeta.textContent = `#${exam.examId} • ${exam.title} • ${exam.questions.length} soru`;
      questionsEl.innerHTML = "";
      exam.questions.forEach((q, idx) => {
        const wrap = document.createElement("div");
        wrap.className = "q";
        wrap.dataset.qid = q.id;
        wrap.dataset.type = q.type;
        wrap.innerHTML = `
          <div class="q-title">${idx+1}. ${escapeHtml(q.text)}
            <span class="tag">${q.type}</span>
          </div>
          <div class="q-body"></div>
        `;
        const body = wrap.querySelector(".q-body");

        if (q.type === "MULTIPLE_CHOICE" && Array.isArray(q.options)) {
          q.options.forEach(opt => {
            const id = `q_${q.id}_${opt}`;
            const row = document.createElement("label");
            row.className = "radio";
            row.innerHTML = `
              <input type="radio" name="q_${q.id}" value="${escapeAttr(opt)}" />
              <span>${escapeHtml(opt)}</span>
            `;
            body.appendChild(row);
          });
        } else if (q.type === "ESSAY") {
          const ta = document.createElement("textarea");
          ta.placeholder = "Cevabınızı yazın…";
          ta.name = `q_${q.id}`;
          body.appendChild(ta);
        } else {
          body.innerHTML = `<div class="muted">Desteklenmeyen soru tipi</div>`;
        }
        questionsEl.appendChild(wrap);
      });
    }

    function collectAnswers() {
      const arr = [];
      questionsEl.querySelectorAll(".q").forEach(qEl => {
        const qid = Number(qEl.dataset.qid);
        const type = qEl.dataset.type;
        let answer = null;
        if (type === "MULTIPLE_CHOICE") {
          const sel = qEl.querySelector('input[type="radio"]:checked');
          if (sel) answer = sel.value;
        } else if (type === "ESSAY") {
          const ta = qEl.querySelector("textarea");
          if (ta && ta.value.trim().length) answer = ta.value.trim();
        }
        if (answer !== null) {
          arr.push({ questionId: qid, answer });
        }
      });
      return arr;
    }

    function escapeHtml(s){ return (s??"").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c])); }
    function escapeAttr(s){ return escapeHtml(s).replace(/"/g, "&quot;"); }

    updateAuthUI();
</script>
</body>
</html>
